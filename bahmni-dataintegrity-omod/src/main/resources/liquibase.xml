<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	<changeSet id="data-integrity-201607221101" author="jaya, deepak" dbms="mysql">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				SELECT COUNT(*) FROM scheduler_task_config
				WHERE schedulable_class = 'org.bahmni.module.DataIntegrityTask'
				And name = 'Data Integrity Task'
			</sqlCheck>
		</preConditions>
		<comment>Inserting Data Integrity Task into 'schedule_task_config' table</comment>
		<insert tableName="scheduler_task_config">
			<column name="name" value="Data Integrity Task" />
			<column name="description" value="runs all integrity rules" />
			<column name="schedulable_class" value="org.bahmni.module.dataintegrity.scheduler.DataIntegrityTask" />
			<column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
			<column name="start_time" valueDate="2011-11-28T23:59:59" />
			<column name="repeat_interval" value="86400" />
			<column name="date_created" valueDate="CURRENT_TIMESTAMP" />
			<column name="created_by" value="1" />
			<column name="uuid" value="8c17b376-1a2b-11e1-a51a-00248140a5eb" />
		</insert>
	</changeSet>

	<changeSet id="data-integrity-201607221102" author="jaya, deepak">
		<createTable tableName="dataintegrity_rule" >
			<column name="rule_id" type="int(11)" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="dataintegrity_rule_pk" nullable="false" />
			</column>

			<column name="rule_name" type="varchar(45)"></column>
			<column name="rule_category" type="varchar(45)"></column>
			<column name="rule_type" type="varchar(45)">
				<constraints nullable="false"/>
			</column>
			<column name="rule_code" type="varchar(500)">
				<constraints nullable="false"/>
			</column>
			<column name="creator" type="int(11)"></column>
			<column name="date_created" type="datetime"></column>
			<column name="retired" type="tinyint(1)"></column>
			<column name="changed_by" type="int(11)"></column>
			<column name="date_changed" type="datetime"></column>
			<column name="retired_by" type="int(11)"></column>
			<column name="date_retired" type="datetime"></column>
			<column name="retire_reason" type="varchar(255)"></column>
			<column name="uuid" type="char(38)"></column>
		</createTable>
	</changeSet>
	<changeSet id="data-integrity-201607221103" author="jaya, deepak">
		<createTable tableName="dataintegrity_result" >
			<column name="result_id" type="int(11)" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="dataintegrity_result_pk" nullable="false" />
			</column>
			<column name="rule_id" type="int(11)">
				<constraints nullable="false"/>
			</column>
			<column name="patient_id" type="int(11)">
			</column>
			<column name="patient_program_id" type="int(11)">
			</column>
			<column name="action_url" type="varchar(500)"></column>
			<column name="notes" type="varchar(500)"></column>
			<column name="creator" type="int(11)"></column>
			<column name="date_created" type="datetime"></column>
			<column name="retired" type="tinyint(1)"></column>
			<column name="changed_by" type="int(11)"></column>
			<column name="date_changed" type="datetime"></column>
			<column name="retired_by" type="int(11)"></column>
			<column name="date_retired" type="datetime"></column>
			<column name="retire_reason" type="varchar(255)"></column>
			<column name="uuid" type="char(38)"></column>
		</createTable>
		<addForeignKeyConstraint baseTableName="dataintegrity_result" baseColumnNames="patient_id"
								 constraintName="patient_id for dataintegrity_result"
								 referencedTableName="patient"
								 referencedColumnNames="patient_id"></addForeignKeyConstraint>


		<addForeignKeyConstraint baseTableName="dataintegrity_result" baseColumnNames="patient_program_id"
								 constraintName="patient_program_id for dataintegrity_result"
								 referencedTableName="patient_program"
								 referencedColumnNames="patient_program_id"></addForeignKeyConstraint>

		<addForeignKeyConstraint baseTableName="dataintegrity_result" baseColumnNames="rule_id"
								 constraintName="rule_id for dataintegrity_result"
								 referencedTableName="dataintegrity_rule"
								 referencedColumnNames="rule_id"></addForeignKeyConstraint>

	</changeSet>
	<changeSet id="data-integrity-201607221053" author="jaya">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">SELECT count(*) from dataintegrity_rule where rule_name='JavaRuleExample'</sqlCheck>
		</preConditions>
		<comment>Add Java Rule Example to Data Integrity Rule</comment>
		<insert tableName="dataintegrity_rule">
			<column name="rule_name" value="JavaRuleExample"/>
			<column name="rule_category" value="java"/>
			<column name="rule_type" value="java"/>
			<column name="rule_code" value="org.bahmni.module.dataintegrity.rule.impl.JavaRuleExample"/>
			<column name="uuid" valueComputed="uuid()"/>
		</insert>
	</changeSet>
	<changeSet id="data-integrity-201607221054" author="jaya">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">SELECT count(*) from dataintegrity_rule where rule_name='Drug Consent'</sqlCheck>
		</preConditions>
		<comment>Add Drug Consent Rule to Data Integrity Rule</comment>
		<insert tableName="dataintegrity_rule">
			<column name="rule_name" value="Drug Consent"/>
			<column name="rule_category" value="java"/>
			<column name="rule_type" value="java"/>
			<column name="rule_code" value="org.bahmni.module.dataintegrity.rule.impl.DrugConsent"/>
			<column name="uuid" valueComputed="uuid()"/>
		</insert>
	</changeSet>
	<changeSet id="data-integrity-201607221055" author="jaya">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">SELECT count(*) from dataintegrity_rule where rule_name='EndTB Drug Consent'</sqlCheck>
		</preConditions>
		<comment>Add EndTB Drug Consent Rule to Data Integrity Rule</comment>
		<insert tableName="dataintegrity_rule">
			<column name="rule_name" value="EndTB Drug Consent"/>
			<column name="rule_category" value="java"/>
			<column name="rule_type" value="java"/>
			<column name="rule_code" value="org.bahmni.module.dataintegrity.rule.impl.EndTBDrugConsent"/>
			<column name="uuid" valueComputed="uuid()"/>
		</insert>
	</changeSet>

</databaseChangeLog>